name: Deploy CI/CD
on:
  push:
    branches:
      - main # executa os testes na branch main
jobs:
  run-tests:
    runs-on: ubuntu-latest
    outputs:
      versao: ${{ steps.docker_build.outputs.tag}}

    steps:
     - name: Checkout
       uses: actions/checkout@v4

     - name: get npm cache directory
       id: npm-cache-dir
       shell: bash
       run: echo "dir=$(npm config get cache)" >> ${GITHUB_OUTPUT}

     - uses: actions/cache@v4
       id: npm-cache
       with:
        path: ${{ steps.npm-cache-dir.outputs.dir}}
        key: npm-cache-dir-${{ hashFiles('**/package-lock.json')}}

     - name: Install dependencias
       run: npm ci
       working-directory: Emprestimoapp  ## busca o nome onde esta as dependencias

     - name: Build app
       run: npm run build
       working-directory: Emprestimoapp

      ## gera o build da imagem
     - name: Build docker image
       working-directory: Emprestimoapp
       id: docker_build
       run: |
          TAG=$(date +'%Y-%m-%d-%H-%M-%S')
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

     - name: Log in to Docker Hub
       uses: docker/login-action@v3
       with:
         username: ${{ secrets.DOCKER_USERNAME }}
         password: ${{ secrets.DOCKERHUB_PAT }}

     - name: Build and push
       uses: docker/build-push-action@v6
       with:
         context: Emprestimoapp
         file: Emprestimoapp/Dockerfile
         push: true
         tags: italopessan/api-emprestimo-githubaction:${{steps.docker_build.outputs.tag}}
         


  # deploy:
  #   needs: [run-tests] ## s√≥ inicia o deploy se run-tests der sucesso
  #   runs-on: ubuntu-latest

  #   steps:

  #    - name: Deploy to Server
  #      run: echo "Deploy ${{ needs.run-tests.outputs.versao}} to server"
