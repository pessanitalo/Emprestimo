name: Emprestimo-Api
on:
  push:
    branches:
      - main # executa os testes na branch main
jobs:
  run-tests:
    runs-on: ubuntu-latest
    outputs:
      versao: ${{ steps.docker_build.outputs.tag}}

    steps:
     - name: Checkout
       uses: actions/checkout@v4

     - uses: actions/cache@v4
       id: cache-emprestimo-api
       with:
        path: ~/.nuget/packages
        key: nuget-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
        restore-keys: |
         nuget-${{ runner.os }}-


     - name: Restore
       run: dotnet restore EmprestimoApi.sln
       working-directory: EmprestimoApi

     - name: Build
       run: dotnet build EmprestimoApi.sln --no-restore
       working-directory: EmprestimoApi

      ## gera o build da imagem
     - name: Build docker image
       working-directory: EmprestimoApi
       id: docker_build
       run: |
          TAG=$(date +'%Y-%m-%d-%H-%M-%S')
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"

     - name: Log in to Docker Hub
       uses: docker/login-action@v3
       with:
         username: ${{ secrets.DOCKER_USERNAME }}
         password: ${{ secrets.DOCKERHUB_PAT }}

    #  - name: Build and push
    #    uses: docker/build-push-action@v6
    #    with:
    #      context: Emprestimoapp
    #      file: Emprestimoapp/Dockerfile
    #      push: true
    #      tags: italopessan/api-emprestimo-githubaction:${{steps.docker_build.outputs.tag}}
         


  # deploy:
  #   needs: [run-tests] ## s√≥ inicia o deploy se run-tests der sucesso
  #   runs-on: ubuntu-latest

  #   steps:

  #    - name: Deploy to Server
  #      run: echo "Deploy ${{ needs.run-tests.outputs.versao}} to server"
